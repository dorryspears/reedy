# Progress Log

## 2026-01-12

### Fixed: Medium Bug #6 - Duplicate Code Between `app.rs` and `rss_manager.rs`

**Location:** `src/rss_manager.rs`

**Problem:** The file `rss_manager.rs` contained 629 lines of dead code that duplicated nearly identical implementations found in `app.rs`. This included `FeedItem`, `SavedState`, `CachedFeed` structs, and many feed management methods. The module was declared in both `main.rs` and `lib.rs` but never actually imported or used anywhere in the codebase.

**Solution:**
1. Deleted the entire `src/rss_manager.rs` file (629 lines of dead code)
2. Removed the `pub mod rss_manager;` declaration from `src/main.rs`
3. Removed the `pub mod rss_manager;` declaration from `src/lib.rs`

**Files changed:**
- `src/rss_manager.rs` - Deleted
- `src/main.rs` - Removed `rss_manager` module declaration
- `src/lib.rs` - Removed `rss_manager` module declaration

**Tests:** All tests pass (16 total: 11 app tests, 5 ui tests)

---

### Fixed: High Bug #5 - Favorites View Not Updated on Unfavorite

**Location:** `src/app.rs:866-893`

**Problem:** When unfavoriting an item while in Favorites view, the item remained visible until the user manually refreshed or toggled the view. This was confusing UX.

**Solution:**
1. Modified `toggle_favorite()` to track whether the item was a favorite before toggling
2. After unfavoriting, if in Favorites view (`PageMode::Favorites`), the item is immediately removed from `current_feed_content`
3. The `selected_index` is adjusted appropriately:
   - If the list becomes empty, `selected_index` is set to `None`
   - If the removed item was at the end, `selected_index` moves to the new last item
   - Otherwise, `selected_index` stays the same (now pointing to the next item)

**Files changed:**
- `src/app.rs` - Modified `toggle_favorite()` to remove unfavorited items from view in Favorites mode
- `tests/app_tests.rs` - Added 3 new tests:
  - `test_unfavorite_removes_from_favorites_view` - verifies item removal and index adjustment
  - `test_unfavorite_last_item_in_favorites_view` - verifies empty list handling
  - `test_unfavorite_does_not_remove_in_feedlist_view` - verifies behavior unchanged in normal view

**Tests:** All tests pass (16 total: 11 app tests, 5 ui tests)

---

### Fixed: High Bug #4 - No HTTP Request Timeouts

**Location:** `src/app.rs` - multiple locations using `reqwest::get()`

**Problem:** All HTTP requests using `reqwest::get()` lacked timeout configuration. When a feed server was slow or unresponsive, the application would hang indefinitely waiting for a response.

**Solution:**
1. Added a `create_http_client()` helper function that creates a `reqwest::Client` with a 30-second timeout
2. Replaced all bare `reqwest::get()` calls with client-based requests using the new helper
3. Added `Duration` to the imports for timeout configuration

**Files changed:**
- `src/app.rs` - Added `create_http_client()` function and updated 5 locations:
  - `is_valid_rss_feed()`
  - `load_feed_content()`
  - `cache_all_feeds()`
  - `refresh_all_feeds()`
  - `fetch_feed()`

**Tests:** All tests pass (13 total: 8 app tests, 5 ui tests)

### Fixed: High Bug #3 - Cache Cleared on Every Startup

**Location:** `src/app.rs:103`

**Problem:** `clear_cache_dir()` was called unconditionally in `App::new()` on every startup, which deleted all cached feed data. This defeated the purpose of caching for offline reading and forced users to wait for feeds to reload every time.

**Solution:** Removed the `clear_cache_dir()` call from `App::new()`. The existing cache system already has proper 1-hour TTL expiration logic in `load_feed_cache()`, making the startup cache clear unnecessary. Also removed the now-unused `clear_cache_dir()` function to avoid dead code.

**Files changed:**
- `src/app.rs` - Removed `clear_cache_dir()` call from `App::new()` and removed the unused `clear_cache_dir()` function

**Tests:** All tests pass (13 total: 8 app tests, 5 ui tests)

### Fixed: Critical Bug #2 - Integer Underflow in `truncate_text`

**Location:** `src/ui.rs:346-361`

**Problem:** When `max_width < 3`, the subtraction `(max_width - 3) as usize` would cause integer underflow, leading to potential panic or unexpected behavior when the terminal is very narrow.

**Solution:** Added an early return guard at the beginning of `truncate_text()` that checks if `max_width < 3`. When true, it returns the text truncated to `max_width` characters without attempting to add ellipsis.

**Files changed:**
- `src/ui.rs` - Added guard for small width values
- `tests/ui_tests.rs` - Added test `test_truncate_text_very_small_width` covering edge cases for width 0, 1, 2, and 3

**Tests:** All tests pass (8 total: 4 app tests, 5 ui tests including new edge case test)

### Fixed: Critical Bug #1 - Panic on Empty List Navigation

**Location:** `src/app.rs:285`, `src/app.rs:296`

**Problem:** `select_previous()` and `select_next()` could panic when navigating an empty list:
- `(current + 1) % len` causes division by zero when `len == 0`
- `len - 1` causes integer underflow when `len == 0`

**Solution:** Added early return guard `if len == 0 { return; }` in both `select_previous()` and `select_next()` functions before any arithmetic operations on `len`.

**Files changed:**
- `src/app.rs` - Added empty list guard in `select_previous()` and `select_next()`
- `tests/app_tests.rs` - Added 4 new tests covering empty list navigation edge cases:
  - `test_select_next_empty_list`
  - `test_select_previous_empty_list`
  - `test_select_next_empty_feed_manager`
  - `test_select_previous_empty_feed_manager`

**Tests:** All tests pass (13 total: 8 app tests, 5 ui tests)

---

### Fixed: Medium Bug #7 - Module Double Declaration

**Location:** `src/main.rs:18-22`

**Problem:** Modules (`app`, `event`, `handler`, `tui`, `ui`) were declared in both `main.rs` and `lib.rs`. This created confusion about which module was being used and potential compilation issues. The `main.rs` was already importing from `reedy::` (the lib crate) but then redundantly re-declared the same modules.

**Solution:**
1. Removed the duplicate module declarations from `src/main.rs` (lines 18-22)
2. The modules remain properly declared in `lib.rs` and are accessed via the `reedy` crate import

**Files changed:**
- `src/main.rs` - Removed 5 redundant `pub mod` declarations

**Tests:** All tests pass (16 total: 11 app tests, 5 ui tests)

---

### Fixed: Medium Bug #8 - Hardcoded Page Sizes

**Location:** `src/app.rs:324-327`, `src/app.rs:613-616`

**Problem:** Page sizes for scrolling were hardcoded to 5 items for FeedList/Favorites and 10 items for FeedManager. This meant pagination didn't adapt to the actual terminal height, causing items to overflow or underflow the visible area.

**Solution:**
1. Added a new `items_per_page()` method that dynamically calculates the number of visible items based on:
   - Terminal height (accounting for 8 lines of UI chrome: 3 title + 3 command bar + 2 borders)
   - Page mode (FeedList/Favorites use 3 lines per item, FeedManager uses 1 line per item)
2. Updated `ensure_selection_visible()` to use `items_per_page()` instead of hardcoded values
3. Updated `page_up()` to use `items_per_page()` instead of hardcoded values
4. Updated `page_down()` to use `items_per_page()` and also fixed it to work correctly in FeedManager mode

**Files changed:**
- `src/app.rs` - Added `items_per_page()` method, updated `ensure_selection_visible()`, `page_up()`, and `page_down()`
- `tests/app_tests.rs` - Added `test_items_per_page_dynamic_calculation` to verify the calculation works correctly for different terminal heights and page modes

**Tests:** All tests pass (17 total: 12 app tests, 5 ui tests)

---

### Fixed: Medium Bug #9 - Blocking Async Patterns

**Location:** `src/app.rs:113-130`, `src/app.rs:885-902`, `src/handler.rs:60-67`, `src/handler.rs:96-100`

**Problem:** The codebase used `tokio::task::block_in_place` with `tokio::runtime::Handle::current().block_on()` to run async code in several places:
1. `App::new()` - blocked during initialization to refresh and cache feeds
2. `toggle_favorites_page()` - blocked when switching from favorites back to feed list
3. `handler.rs` - blocked in the 'c' key handlers for refreshing/caching feeds

This pattern is inefficient and can cause deadlocks in certain scenarios because it blocks the current thread waiting for async operations, defeating the purpose of async programming.

**Solution:**
1. Converted `App::new()` from sync to async - now called with `.await` in main.rs
2. Converted `toggle_favorites_page()` from sync to async - now called with `.await` in handler.rs
3. Removed all `block_in_place` and `block_on` calls from handler.rs - the handler is already async, so async methods can be awaited directly
4. Updated `main.rs` to await the async `App::new()` call

**Files changed:**
- `src/app.rs` - Made `App::new()` and `toggle_favorites_page()` async, removed blocking wrappers
- `src/handler.rs` - Removed `block_in_place`/`block_on` wrappers, now directly awaits async methods
- `src/main.rs` - Updated to await `App::new()`

**Tests:** All tests pass (17 total: 12 app tests, 5 ui tests)

---

### Fixed: Low Bug #10 - Debug Statement Left in Code

**Location:** `src/app.rs:436` (was `src/app.rs:413` before previous fixes shifted line numbers)

**Problem:** A leftover debug statement `debug!("test");` existed in the `select_feed()` function that served no purpose. This was likely left behind during development and cluttered the debug output.

**Solution:** Removed the useless `debug!("test");` statement. The function already has a proper debug statement on the next line that logs meaningful context: `debug!("Loading feed content from index {}", index);`

**Files changed:**
- `src/app.rs` - Removed `debug!("test");` from `select_feed()` function

**Tests:** All tests pass (17 total: 12 app tests, 5 ui tests)

---

### Implemented: High Priority Feature #1 - Search/Filter Functionality

**Location:** `src/app.rs`, `src/handler.rs`, `src/ui.rs`

**Description:** Added the ability to filter feed items by keyword in title or description. This is an essential feature for users with many subscriptions to find specific content.

**Implementation Details:**

1. **New InputMode:** Added `InputMode::Searching` to handle search text input
2. **New App fields:**
   - `search_query: String` - stores the current search query
   - `filtered_indices: Option<Vec<usize>>` - stores indices of matching items when filter is active
3. **New App methods:**
   - `start_search()` - enters search mode
   - `cancel_search()` - cancels search and clears filter
   - `confirm_search()` - confirms search, keeps filter active
   - `update_search_filter()` - updates filtered indices based on query
   - `clear_search()` - clears filter when pressing Esc in normal mode
   - `get_visible_items()` - returns filtered or all items based on filter state
   - `visible_item_count()` - returns count of visible items
   - `get_actual_index()` - converts visible index to actual index in feed content

4. **Key bindings:**
   - `/` - Start search mode (in FeedList and Favorites views)
   - `Enter` - Confirm search and keep filter active
   - `Esc` - Cancel search (clears filter), or clear active filter in normal mode

5. **UI Updates:**
   - Command bar shows search input with cursor during search mode
   - Title bar shows filter indicator when filter is active: `[Filter: "query"]`
   - Shows filtered item count vs total: "Items 1-5/5 of 50"
   - Help menu updated with search documentation

6. **Modified existing methods to work with filtered indices:**
   - `select_previous()`, `select_next()` - navigate filtered list
   - `open_selected_feed()` - uses actual index
   - `toggle_read_status()` - uses actual index
   - `mark_as_read()` - uses actual index
   - `mark_all_as_read()` - marks only visible (filtered) items
   - `toggle_favorite()` - uses actual index, handles filter index updates

**Files changed:**
- `src/app.rs` - Added search state, methods, and updated existing methods
- `src/handler.rs` - Added search mode key handling and `/` key binding
- `src/ui.rs` - Updated rendering to show filtered items and search UI
- `tests/app_tests.rs` - Added 3 new tests for search functionality

**Tests:** All tests pass (20 total: 15 app tests, 5 ui tests)
